<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>kusoge インデックス</title>
  <meta name="description" content="GitHub Pages の /kusoge/ にあるデモ（/1, /2, ...）を自動参照して日本語案内を生成します。">
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --border:#1f2937; --text:#e5e7eb;
      --muted:#94a3b8; --link:#60a5fa; --ok:#22c55e; --warn:#eab308;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
    header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ctrl{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:13px}
    input[type="number"], input[type="text"], button, a.btn{
      padding:8px 10px;border-radius:10px;border:1px solid #334155;background:#111827;color:var(--text);
    }
    button,a.btn{cursor:pointer;text-decoration:none}
    button:hover, a.btn:hover{border-color:#3b4b63}
    main{padding:14px;max-width:1100px;margin:0 auto}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}
    .url{font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--muted);font-size:12px;word-break:break-all}
    .desc{color:#cbd5e1;line-height:1.6}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1224;font-size:11px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    iframe.preview{width:100%;height:280px;border:1px solid var(--border);border-radius:8px;background:#000}
    footer{padding:14px;text-align:center;color:var(--muted);border-top:1px solid var(--border);margin-top:16px}
    .warn{color:var(--warn)}
    details summary.btn{display:inline-block}
  </style>
</head>
<body>
<header>
  <h1>kusoge インデックス</h1>
  <div class="controls">
    <div class="ctrl">
      <label for="maxNum">最大番号</label>
      <input id="maxNum" type="number" min="1" step="1" value="20" />
    </div>
    <div class="ctrl">
      <label for="basePath">ベース</label>
      <input id="basePath" type="text" value="/kusoge/" size="10" />
    </div>
    <button id="scanBtn">再スキャン</button>
    <button id="exportBtn" title="現在の一覧を list.json として書き出します">JSONを書き出し</button>
  </div>
</header>

<main>
  <p id="hint" style="color:#cbd5e1;margin:0 0 10px;">
    まずは <code>/kusoge/list.json</code> を探し、なければ <code>/kusoge/1..N</code> を自動スキャンして存在するページだけ表示します。
  </p>
  <section class="grid" id="cards"></section>
</main>

<footer>
  <small>© lamb5656 / GitHub Pages</small>
</footer>

<script>
const cardsEl = document.getElementById("cards");
const maxInput = document.getElementById("maxNum");
const baseInput = document.getElementById("basePath");
const scanBtn  = document.getElementById("scanBtn");
const exportBtn = document.getElementById("exportBtn");

// URLパラメータから初期値
const params = new URLSearchParams(location.search);
if (params.has("max")) maxInput.value = String(Math.max(1, Number(params.get("max")||20)));
if (params.has("base")) baseInput.value = params.get("base") || "/kusoge/";

// ローカル保存から復元
try {
  const saved = JSON.parse(localStorage.getItem("kusoge-index-prefs")||"{}");
  if (saved.max)  maxInput.value = saved.max;
  if (saved.base) baseInput.value = saved.base;
} catch {}

function savePrefs(){
  localStorage.setItem("kusoge-index-prefs", JSON.stringify({max:maxInput.value, base:baseInput.value}));
}

function summarize(text, len=140){
  if(!text) return "";
  const s = text.replace(/\s+/g," ").trim();
  return s.length>len ? s.slice(0,len)+"…" : s;
}

async function headOk(url){
  try{
    const r = await fetch(url, {method:"HEAD", cache:"no-store"});
    if (r.ok) return true;
    // HEADが不安定な環境向けフォールバック
    const r2 = await fetch(url, {method:"GET", cache:"no-store"});
    return r2.ok;
  }catch{ return false; }
}

async function getLastModified(url){
  try{
    const r = await fetch(url, {method:"HEAD", cache:"no-store"});
    return r.headers.get("last-modified") || "";
  }catch{ return ""; }
}

async function fetchMeta(url){
  try{
    const [htmlRes, lm] = await Promise.all([
      fetch(url, {cache:"no-store"}),
      getLastModified(url)
    ]);
    if (!htmlRes.ok) throw new Error("status "+htmlRes.status);
    const text = await htmlRes.text();
    const doc = new DOMParser().parseFromString(text, "text/html");
    const title = (doc.querySelector("title")?.textContent || "").trim();
    const metaDesc = (doc.querySelector('meta[name="description"]')?.getAttribute("content") || "").trim();
    const h1 = (doc.querySelector("h1")?.textContent || "").trim();

    let bodyText = "";
    const scope = doc.querySelector("main") || doc.body;
    if (scope) {
      bodyText = Array.from(scope.querySelectorAll("p,li,small"))
        .map(n=>n.textContent.trim())
        .filter(Boolean).join(" ");
    }
    return { ok:true, title:title||h1, desc: metaDesc || summarize(bodyText, 180), lastModified: lm };
  }catch(e){
    return { ok:false, title:"（取得できませんでした）", desc:"リンクを開いて内容をご確認ください。", lastModified:"" };
  }
}

function fmtDateRFC(dstr){
  if(!dstr) return "";
  const d = new Date(dstr);
  if (isNaN(d)) return "";
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0"), mm=String(d.getMinutes()).padStart(2,"0");
  return `${y}/${m}/${da} ${hh}:${mm}`;
}

function createCard(item){
  const { url, title, desc, lastModified } = item;
  const card = document.createElement("article");
  card.className = "card";

  const t = document.createElement("div");
  t.className = "title";
  t.textContent = title || "(無題)";

  const u = document.createElement("div");
  u.className = "url";
  u.textContent = url;

  const d = document.createElement("div");
  d.className = "desc";
  d.textContent = desc || "";

  const meta = document.createElement("div");
  meta.className = "meta";
  const lm = document.createElement("span");
  lm.className = "badge";
  lm.innerHTML = "最終更新: " + (lastModified ? fmtDateRFC(lastModified) : '<span class="warn">不明</span>');
  meta.appendChild(lm);

  const actions = document.createElement("div");
  actions.className = "actions";

  const open = document.createElement("a");
  open.className = "btn";
  open.href = url; open.target = "_blank"; open.rel = "noopener";
  open.textContent = "新しいタブで開く";

  const pv = document.createElement("details");
  const sum = document.createElement("summary"); sum.className = "btn"; sum.textContent = "プレビューを表示";
  const frame = document.createElement("iframe"); frame.className="preview"; frame.loading="lazy"; frame.src=url;
  pv.appendChild(sum); pv.appendChild(frame);

  actions.appendChild(open); actions.appendChild(pv);

  card.appendChild(t);
  card.appendChild(u);
  card.appendChild(d);
  card.appendChild(meta);
  card.appendChild(actions);

  return card;
}

// list.json を読む（存在しないなら null）
async function tryLoadListJson(base){
  const url = new URL(base.replace(/\/+$/,"") + "/list.json", location.origin).toString();
  try{
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) return null;
    const j = await r.json();
    if (!Array.isArray(j.items)) return null;
    // {items:[{path:"/kusoge/1/", title?, desc?}, ...]}
    return j.items.map(it => ({
      url: new URL(it.path, location.origin).toString(),
      title: it.title || "",
      desc: it.desc || "",
      lastModified: ""
    }));
  }catch{ return null; }
}

// 自動スキャン（/1..max）
async function autoScan(base, maxN){
  const list = [];
  const baseUrl = new URL(base, location.origin);
  for (let i=1; i<=maxN; i++){
    const url = new URL(String(i).replace(/\/?$/,"/"), baseUrl).toString();
    // 例: https://.../kusoge/1/
    /* eslint-disable no-await-in-loop */
    const ok = await headOk(url);
    if (ok) {
      list.push({ url, title:"", desc:"", lastModified:"" });
    }
  }
  return list;
}

async function build(){
  savePrefs();
  cardsEl.innerHTML = "";
  const base = baseInput.value;
  const maxN = Math.max(1, Number(maxInput.value||20));
  const hint = document.getElementById("hint");
  hint.textContent = "読み込み中…（list.json を探し、なければ "+base+"1.."+maxN+" をスキャン）";

  // 1) list.json 優先
  let items = await tryLoadListJson(base);

  // 2) なければ自動スキャン
  if (!items) {
    items = await autoScan(base, maxN);
  }

  if (items.length === 0) {
    hint.innerHTML = `ページが見つかりませんでした。<br>・${base} 配下に <code>1</code> 〜 <code>${maxN}</code> のフォルダ（index.html）があるか確認してください。<br>・または <code>${base.replace(/\/+$/,"")}/list.json</code> を用意してください。`;
    return;
  }

  // メタ取得
  const metas = await Promise.all(items.map(async it => {
    const m = await fetchMeta(it.url);
    return {
      url: it.url,
      title: it.title || m.title,
      desc: it.desc || m.desc,
      lastModified: m.lastModified
    };
  }));

  // 表示
  hint.textContent = "";
  for (const item of metas){
    cardsEl.appendChild(createCard(item));
  }

  // 現在の一覧を保持（書き出し用）
  window.__currentItems = metas.map(m => {
    return { path: new URL(m.url).pathname, title: m.title, desc: m.desc };
  });
}

scanBtn.addEventListener("click", build);
exportBtn.addEventListener("click", () => {
  const items = window.__currentItems || [];
  const payload = JSON.stringify({ items }, null, 2);
  const blob = new Blob([payload], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "list.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

// 初回ビルド
build();
</script>
</body>
</html>